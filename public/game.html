<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tmrflip - Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="game.css">
  <style>
    body {
      margin: 0;
      font-family: 'Comic Sans MS', sans-serif;
      background: #000; /* Black background */
      color: #fff;
      overflow: hidden;
    }
    #tmr-title {
      position: absolute;
      top: 15px; left: 32px;
      font-size: 2em;
      letter-spacing: 2px;
    }
    #table-area {
      position: absolute;
      top: 100px; left: 0; right: 0;
      height: 260px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
    }
    #deck-pile, #discard-pile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 40px;
    }
    #deck-pile .pile-card {
      width: 90px; height: 140px;
      background: url('https://media.discordapp.net/attachments/1018571001992323082/1389152983593386044/bear.png?ex=68639508&is=68624388&hm=8de1d33acb680fb1f5205cf14e169f790a40004ab4823cf88fcd70ac70b8fdc6&=&format=webp&quality=lossless&width=1164&height=823') center/cover no-repeat, #333;
      border: 2px solid #fff;
      font-size: 2em;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 8px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 2px 6px 16px #0002;
    }
    #discard-pile .pile-card {
      width: 90px; height: 140px;
      background: #222;
      border: 2px solid #fff;
      font-size: 2em;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 8px;
      border-radius: 12px;
    }
    .card-back, .opponent-card-behind {
      min-width: 34px; min-height: 48px;
      width: 38px; height: 56px;
      background: url('https://media.discordapp.net/attachments/1018571001992323082/1389152983593386044/bear.png?ex=68639508&is=68624388&hm=8de1d33acb680fb1f5205cf14e169f790a40004ab4823cf88fcd70ac70b8fdc6&=&format=webp&quality=lossless&width=1164&height=823') center/cover no-repeat, #555;
      border: 2px solid #fff;
      border-radius: 6px;
      margin-bottom: 2px;
      margin-right: 2px;
      display: inline-block;
      box-shadow: 1px 2px 6px #000a;
    }
    .opponent-name {
      font-size: 1.1em;
      text-align: center;
    }
    #left-player, #right-player {
      position: absolute;
      top: 35%;
      width: 120px;
      height: 130px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
    }
    #left-player { left: 30px; }
    #right-player { right: 30px; }
    .opponent-cards {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      margin-bottom: 4px;
      max-width: 112px;
      justify-content: center;
    }
    #my-hand {
      position: absolute;
      bottom: 32px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 10px;
      z-index: 2;
      max-width: 85vw;
      overflow-x: auto;
      padding-bottom: 6px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      min-height: 72px;
    }
    .your-card {
      min-width: 44px; min-height: 62px;
      background: #444;
      border-radius: 7px;
      border: 2px solid #fff;
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 1px 2px 6px #000a;
      transition: transform 0.1s;
      position: relative;
    }
    .your-card:hover {
      transform: translateY(-8px) scale(1.12);
      border: 2px solid yellow;
      z-index: 2;
      background: #666;
    }
    .my-turn-glow {
      box-shadow: 0 0 8px 2px yellow;
      border-color: yellow !important;
    }
    .disabled-hand .your-card {
      pointer-events: none !important;
      filter: grayscale(0.7) brightness(0.8);
      opacity: 0.7;
      border-color: #aaa !important;
      transition: none !important;
      cursor: not-allowed !important;
    }
    .disabled-hand .your-card:hover {
      transform: none !important;
      border-color: #aaa !important;
      background: #666 !important;
    }
    #readyBtn {
      position: absolute;
      top: 32px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      background: #ffe24a;
      color: #222;
      border: none;
      border-radius: 10px;
      padding: 13px 34px;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      z-index: 101;
      transition: background 0.15s;
      box-shadow: 0 1px 16px #ffe24a88;
      border: 2px solid #ffe24a;
    }
    #readyBtn:hover {
      background: #fff;
      color: #111;
    }
    #readyStatus {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.13em;
      z-index: 101;
      color: #ffe24a;
      font-weight: bold;
      background: #fffbe4;
      padding: 2.5px 15px;
      border-radius: 8px;
      box-shadow: 0 1px 8px #ffe24a33;
      border: 1.4px solid #ffe24a;
    }
    /* --- CHAT CHANGES START --- */
    #chat-popup {
      position: fixed;
      right: 24px; bottom: 24px;
      width: 300px;
      background: rgba(25,25,25,0.77);
      border-radius: 12px;
      box-shadow: 0 0 10px #000d;
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: all 0.15s;
      border: 2px dashed #fff;
    }
    #chat-header {
      background: rgba(36,36,36,0.7);
      padding: 8px 12px;
      border-radius: 12px 12px 0 0;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-bottom: 2px dashed #fff;
    }
    #chat-messages {
      height: 180px;
      overflow-y: auto;
      padding: 10px;
      font-size: 1em;
      background: transparent;
      color: #fff;
    }
    #chat-input {
      width: 76%;
      margin: 5px;
      border-radius: 6px;
      font-size: 1em;
      border: 1px solid #999;
      background: #222;
      color: #fff;
      padding: 4px 8px;
    }
    #chat-send {
      width: 20%;
      background: #fff;
      color: #222;
      border-radius: 6px;
      border: none;
      font-size: 1em;
      cursor: pointer;
      margin: 5px 5px 5px 0;
      font-weight: bold;
      transition: background 0.15s;
    }
    #chat-minimized {
      display: none;
      position: fixed;
      right: 24px; bottom: 24px;
      border: 2px dashed #fff;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 0 8px #000a;
      background: rgba(25,25,25,0.88);
      z-index: 101;
      cursor: pointer;
      width: 180px;
      transition: all 0.15s;
    }
    .chat-min-header {
      font-weight: bold;
      letter-spacing: 1px;
      text-align: center;
      font-size: 1.11em;
      color: #fff;
      padding: 9px 0 8px 0;
      border-radius: 12px 12px 0 0;
      background: rgba(36,36,36,0.85);
      border-bottom: 2px dashed #fff;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    @media (max-width: 700px) {
      #left-player, #right-player { display: none; }
      #chat-popup, #chat-minimized { width: 98vw; right: 1vw;}
      #readyBtn, #readyStatus { right: 10vw;}
      #my-hand { max-width: 98vw; }
    }
    /* --- CHAT CHANGES END --- */
  </style>
</head>
<body>
  <div id="tmr-title">tmrflip</div>
  <button id="readyBtn" onclick="sendReady()">Ready</button>
  <div id="readyStatus"></div>
  <div id="table-area">
    <div id="discard-pile">
      <div class="pile-card" id="discard-card">-</div>
      <div class="label" style="color:#0a7;">Discard</div>
    </div>
    <div id="deck-pile">
      <div class="pile-card" id="deck-card" onclick="drawCard()"></div>
      <button id="draw-btn" onclick="drawCard()">Draw Card</button>
    </div>
  </div>
  <div id="left-player"></div>
  <div id="right-player"></div>
  <div id="my-hand"></div>
  <!-- Chat Popup -->
  <div id="chat-popup">
    <div id="chat-header">
      <span>Chat</span>
      <span id="chat-close" title="Hide chat" aria-label="Hide chat">&times;</span>
    </div>
    <div id="chat-messages"></div>
    <input id="chat-input" type="text" placeholder="Type..." autocomplete="off" />
    <button id="chat-send">Send</button>
  </div>
  <!-- Messenger style minimized chat (header only, click to expand) -->
  <div id="chat-minimized" style="display:none;">
    <div class="chat-min-header">Chat</div>
  </div>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const myName = urlParams.get("name");
    let allPlayers = [];
    let handCounts = [];
    let myHand = [];
    let currentPlayer = "";
    let myIndex = 0;
    let isReady = false; // Track ready state

    if (!code || !myName) {
      alert("Missing name or room code.");
      window.location.href = "/index.html";
    }

    // --- Player POV arrangement ---
    function rotatePlayers(players, me) {
      const idx = players.indexOf(me);
      if (idx === -1) return players;
      return players.slice(idx).concat(players.slice(0, idx));
    }
    function rotateHandCounts(counts, idx) {
      return counts.slice(idx).concat(counts.slice(0, idx));
    }

    function renderOpponents(players, counts) {
      document.getElementById('left-player').innerHTML = '';
      document.getElementById('right-player').innerHTML = '';
      if (players.length < 2) return;
      const leftIdx = (players.length - 1);
      const rightIdx = 1 % players.length;
      if (players.length > 2) {
        const leftDiv = document.getElementById('left-player');
        leftDiv.innerHTML = `
          <div class="opponent-cards">${
            Array.from({length: counts[leftIdx]}).map(()=>'<div class="opponent-card-behind"></div>').join('')
          }</div>
          <div class="opponent-name">${players[leftIdx]}</div>
        `;
      }
      const rightDiv = document.getElementById('right-player');
      rightDiv.innerHTML = `
        <div class="opponent-cards">${
          Array.from({length: counts[rightIdx]}).map(()=>'<div class="opponent-card-behind"></div>').join('')
        }</div>
        <div class="opponent-name">${players[rightIdx]}</div>
      `;
    }
    function renderHand(hand) {
      const handDiv = document.getElementById('my-hand');
      handDiv.innerHTML = '';
      hand.forEach(card => {
        const el = document.createElement('div');
        el.className = 'your-card';
        if (card.color === 'Wild') {
          el.style.background = 'linear-gradient(135deg,#444,#fff)';
          el.style.color = '#000';
        } else if(card.color) {
          el.style.backgroundColor = card.color ? card.color.toLowerCase() : '#444';
        }
        el.textContent = card.value + (card.color && card.color !== 'Wild' ? ' ' + card.color[0] : '');
        if (isReady) {
          el.onclick = () => playCard(card);
        }
        handDiv.appendChild(el);
      });
      if (!isReady) {
        handDiv.classList.add('disabled-hand');
      } else {
        handDiv.classList.remove('disabled-hand');
      }
    }
    function renderDiscard(card) {
      const discard = document.getElementById('discard-card');
      if (!card) {
        discard.textContent = '-';
        discard.style.background = '#222';
        return;
      }
      discard.textContent = `${card.value}${card.color && card.color !== "Wild" ? " " + card.color[0] : card.color === "Wild" ? " 🃏" : ""}`;
      discard.style.background = (card.color && card.color !== 'Wild') ? card.color.toLowerCase() : '#333';
      discard.style.color = (card.color === 'Yellow') ? '#444' : '#fff';
    }

    function drawCard() {
      if (isReady) socket.emit("drawCard");
    }
    function playCard(card) {
      if (!isReady) return;
      if (card.color === 'Wild') {
        const chosenColor = prompt('Choose color: Red, Green, Blue, Yellow');
        if (!chosenColor || !['red','green','blue','yellow'].includes(chosenColor.toLowerCase())) return;
        card.chosenColor = chosenColor.charAt(0).toUpperCase() + chosenColor.slice(1).toLowerCase();
      }
      socket.emit("playCard", card);
    }
    function sendReady() {
      isReady = true;
      socket.emit("playerReady");
      document.getElementById('my-hand').classList.remove('disabled-hand');
      document.getElementById('readyBtn').disabled = true;
    }

    // --- Chat logic ---
    const chatMessages = document.getElementById('chat-messages');
    document.getElementById('chat-send').onclick = sendChat;
    document.getElementById('chat-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendChat();
    });
    function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;
      socket.emit('chat-message', { code, name: myName, message: msg });
      input.value = '';
    }
    socket.on('chat-message', ({ name, message }) => {
      const div = document.createElement('div');
      div.innerHTML = `<b>${name}:</b> ${message}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // --- Chat minimize/maximize ---
    document.getElementById('chat-close').onclick = function(e) {
      document.getElementById('chat-popup').style.display = 'none';
      document.getElementById('chat-minimized').style.display = '';
      e.stopPropagation();
    };
    document.getElementById('chat-minimized').onclick = function() {
      document.getElementById('chat-popup').style.display = '';
      document.getElementById('chat-minimized').style.display = 'none';
    };

    socket.emit("joinGame", myName);

    socket.on('joinFailed', (msg) => alert(msg));

    socket.on('startGame', () => {
      document.getElementById('draw-btn').style.display = '';
      document.getElementById('readyBtn').style.display = "none";
      document.getElementById('readyStatus').style.display = "none";
    });

    socket.on('updateTopCard', (card) => {
      renderDiscard(card);
    });

    socket.on('updateHand', (hand) => {
      myHand = hand;
      renderHand(hand);
    });

    socket.on('yourTurn', (yes) => {
      document.getElementById('draw-btn').disabled = !yes || !isReady;
      document.getElementById('my-hand').classList.toggle('my-turn-glow', yes && isReady);
    });

    socket.on('updatePlayers', ({ players, handCounts: counts, currentPlayer, readyCounts }) => {
      allPlayers = players;
      handCounts = counts;
      myIndex = players.indexOf(myName);
      const rotatedPlayers = rotatePlayers(players, myName);
      const rotatedCounts = rotateHandCounts(counts, myIndex);
      renderOpponents(rotatedPlayers, rotatedCounts);
      [document.getElementById('left-player'), document.getElementById('right-player')].forEach(div => div.classList.remove('my-turn-glow'));
      if (rotatedPlayers[1] === currentPlayer) document.getElementById('right-player').classList.add('my-turn-glow');
      if (rotatedPlayers.length > 2 && rotatedPlayers[rotatedPlayers.length-1] === currentPlayer) document.getElementById('left-player').classList.add('my-turn-glow');
      if (readyCounts && typeof readyCounts.ready !== "undefined" && typeof readyCounts.total !== "undefined") {
        document.getElementById('readyStatus').textContent = `Ready: ${readyCounts.ready}/${readyCounts.total}`;
        if (readyCounts.ready === readyCounts.total) {
          document.getElementById('readyBtn').style.display = "none";
        } else {
          document.getElementById('readyBtn').style.display = "";
        }
      }
    });

    socket.on('gameOver', ({ winner }) => {
      alert(`${winner} has won the game!`);
    });

    window.onload = () => {
      document.getElementById('draw-btn').disabled = true;
      document.getElementById('my-hand').classList.add('disabled-hand');
      isReady = false;
    };
  </script>
</body>
</html>
