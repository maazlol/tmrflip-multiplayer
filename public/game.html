<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tmrflip - Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    #playersArea {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .player-box {
      border: 2px dashed white;
      border-radius: 12px;
      width: 160px;
      height: 110px;
      padding: 6px;
      color: white;
      background-color: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    .player-name {
      font-weight: bold;
      font-size: 14px;
    }

    .player-cards {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .card {
      width: 24px;
      height: 36px;
      border-radius: 4px;
      background-color: gray;
    }

    #topCard {
      font-size: 18px;
      margin: 10px;
      padding: 10px;
      border: 2px solid white;
      border-radius: 8px;
      background-color: #222;
    }

    #readyStatus {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    #yourHand {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .your-card {
      padding: 10px;
      border-radius: 6px;
      background-color: #444;
      cursor: pointer;
      min-width: 36px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      border: 2px solid #222;
      transition: transform 0.1s;
    }
    .your-card:hover {
      transform: translateY(-5px) scale(1.1);
      border: 2px solid yellow;
      z-index: 2;
    }

    #drawBtn, #readyBtn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background: white;
      color: black;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #drawBtn[disabled] {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    #titleBanner {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="titleBanner">tmrflip</div>
  <div id="readyStatus">Ready: 0/0</div>

  <button id="readyBtn" onclick="sendReady()">I'm Ready</button>
  <div id="topCard">Top Card: -</div>
  <div id="playersArea"></div>
  <div id="yourHand"></div>
  <button id="drawBtn" onclick="drawCard()">Draw Card</button>

  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const myName = urlParams.get("name");

    if (!code || !myName) {
      alert("Missing name or room code.");
      window.location.href = "/index.html";
    }

    socket.emit("joinGame", myName);

    function sendReady() {
      socket.emit("playerReady");
    }

    function drawCard() {
      socket.emit("drawCard");
    }

    function playCard(card) {
      socket.emit("playCard", card);
    }

    function renderPlayers(players, handCounts, currentPlayerName) {
      const area = document.getElementById('playersArea');
      area.innerHTML = '';

      players.forEach((name, i) => {
        const box = document.createElement('div');
        box.className = 'player-box';

        const nameEl = document.createElement('div');
        nameEl.className = 'player-name';
        nameEl.textContent = name + (name === currentPlayerName ? ' ðŸ‘‘' : '');

        const cards = document.createElement('div');
        cards.className = 'player-cards';

        const count = handCounts[i];
        for (let j = 0; j < count; j++) {
          const card = document.createElement('div');
          card.className = 'card';
          cards.appendChild(card);
        }

        box.appendChild(nameEl);
        box.appendChild(cards);
        area.appendChild(box);
      });
    }

    socket.on('joinFailed', (msg) => alert(msg));

    socket.on('startGame', () => {
      document.getElementById('readyBtn').style.display = 'none';
    });

    socket.on('updateTopCard', (card) => {
      document.getElementById('topCard').textContent = `Top Card: ${card.color} ${card.value}`;
    });

    socket.on('updateHand', (hand) => {
      const handDiv = document.getElementById('yourHand');
      handDiv.innerHTML = '';
      hand.forEach(card => {
        const el = document.createElement('div');
        el.className = 'your-card';
        el.style.backgroundColor = card.color.toLowerCase();
        el.textContent = card.value;
        el.onclick = () => playCard(card);
        handDiv.appendChild(el);
      });
    });

    socket.on('yourTurn', (yes) => {
      document.getElementById('drawBtn').disabled = !yes;
    });

    // NEW: Show ready count
    socket.on('updatePlayers', ({ players, handCounts, currentPlayer, readyCounts }) => {
      if (readyCounts && typeof readyCounts.ready !== "undefined" && typeof readyCounts.total !== "undefined") {
        document.getElementById('readyStatus').textContent = `Ready: ${readyCounts.ready}/${readyCounts.total}`;
      }
      renderPlayers(players, handCounts, currentPlayer);
    });

    socket.on('gameOver', ({ winner }) => {
      alert(`${winner} has won the game!`);
    });
  </script>
</body>
</html>
